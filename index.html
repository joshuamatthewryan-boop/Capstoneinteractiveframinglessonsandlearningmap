<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Framing Lessons — Global Humanity Resource</title>
  <meta name="description" content="Interactive world map and detail panel for a meta-analysis of lesson framing practices." />
  <style>
    :root{
      --bg:#0b0c10;--panel:#0f1115;--ink:#e6e7eb;--muted:#9aa3b2;--accent:#4f8cff;--accent2:#8e5cff;--chip:rgba(255,255,255,.08);--chipBr:rgba(255,255,255,.12);
    }
    html,body{height:100%}
    body{margin:0;color:var(--ink);background:radial-gradient(1200px 800px at 20% -10%,#162033 0%,#0b0c10 60%);font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans','Arial Unicode MS',Arial,sans-serif;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
    header{padding:1rem clamp(1rem,3vw,2rem);display:grid;grid-template-columns:1fr auto;gap:1rem;align-items:center;border-bottom:1px solid rgba(255,255,255,.08);position:sticky;top:0;z-index:10;background:linear-gradient(180deg,rgba(15,17,21,.85),rgba(15,17,21,.65))}
    .title{font-weight:700;letter-spacing:.2px;font-size:clamp(1.1rem,1.8vw,1.35rem);display:flex;align-items:center;gap:.75rem}
    .title .dot{width:10px;height:10px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));box-shadow:0 0 12px rgba(79,140,255,.6)}
    .controls{display:flex;gap:.6rem;align-items:center;flex-wrap:wrap}
    select,button,.pill{background:var(--chip);color:var(--ink);border:1px solid var(--chipBr);padding:.5rem .65rem;border-radius:10px;font-size:.95rem}
    button{cursor:pointer}
    .hint{color:var(--muted);font-size:.92rem}
    .email{color:var(--ink);text-decoration:none;border-bottom:1px dashed var(--chipBr)}
    .wrap{display:grid;grid-template-columns:minmax(320px,1fr) minmax(360px,480px);gap:clamp(12px,2vw,16px);padding:clamp(12px,2vw,16px)}
    @media (max-width:980px){.wrap{grid-template-columns:1fr}}
    .map-card,.panel{background:var(--panel);border:1px solid rgba(255,255,255,.07);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .map-card{position:relative;overflow:hidden}
    .map-toolbar{position:absolute;top:10px;right:12px;display:flex;gap:8px;z-index:2}
    .panel{padding:1rem 1rem 1.25rem;min-height:320px;display:flex;flex-direction:column}
    .panel h2{font-size:1.05rem;margin:0 0 .25rem;font-weight:700}
    .panel .sub{color:var(--muted);font-size:.9rem;margin-bottom:.75rem}
    .panel .locked{font-size:.9rem;margin-bottom:.5rem;display:flex;align-items:center;gap:.5rem}
    .cards{display:grid;gap:.75rem;grid-auto-rows:min-content}
    .card{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);border-radius:12px;padding:.8rem .9rem}
    .card h3{margin:0 0 .5rem;font-size:1rem;display:flex;flex-wrap:wrap;gap:.4rem .5rem;align-items:center}
    .chips{display:flex;gap:.35rem;flex-wrap:wrap}
    .chip{background:var(--chip);border:1px solid var(--chipBr);border-radius:999px;padding:.15rem .5rem;font-size:.75rem;color:var(--muted)}
    .section{margin-top:.35rem}
    .section h4{margin:.55rem 0 .25rem;font-size:.85rem;color:var(--muted);font-weight:600;letter-spacing:.2px}
    .section p{margin:0;white-space:pre-wrap;line-height:1.32}
    .empty{color:var(--muted);font-style:italic}
    .summary-list{display:grid;gap:.5rem}
    .summary-item{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);border-radius:12px;padding:.6rem .7rem}
    .summary-item .name{font-weight:650}
    .summary-item .locs{color:var(--muted);font-size:.9rem;margin-top:.2rem}
    .diag{color:var(--muted);font-size:.8rem;margin-top:.75rem;border-top:1px dashed rgba(255,255,255,.1);padding-top:.5rem}
    svg{display:block;width:100%;height:clamp(360px,62vh,780px);background:radial-gradient(1000px 600px at 50% -20%,rgba(79,140,255,.08),transparent 60%)}
    .country{fill:#1a212f;stroke:rgba(255,255,255,.08);stroke-width:.6;cursor:pointer;transition:fill 120ms ease-out,opacity 120ms ease-out}
    .country.hasData{fill:#1e2e4a}
    .country:hover{opacity:.9}
    .country.locked{stroke:var(--accent);stroke-width:1.4}
    .graticule{fill:none;stroke:rgba(255,255,255,.07);stroke-width:.4}
    .legend{position:absolute;left:12px;bottom:12px;display:flex;gap:.5rem;align-items:center;background:rgba(0,0,0,.25);padding:.35rem .5rem;border-radius:8px;border:1px solid rgba(255,255,255,.08);font-size:.85rem;color:var(--muted)}
    .swatch{width:14px;height:10px;border:1px solid rgba(255,255,255,.2)}
    .swatch-yes{background:#1e2e4a}
    .swatch-no{background:#1a212f}
    /* Accordion UI */
    .accordion{display:grid;gap:.5rem}
    .acc-item{border:1px solid rgba(255,255,255,.08);border-radius:12px;background:rgba(255,255,255,.03);overflow:hidden}
    .acc-header{display:flex;align-items:center;justify-content:space-between;gap:.75rem;padding:.65rem .8rem;cursor:pointer}
    .acc-title{font-weight:650}
    .acc-chips{display:flex;gap:.35rem;flex-wrap:wrap}
    .acc-arrow{transition:transform .18s ease}
    .acc-item[aria-expanded="true"] .acc-arrow{transform:rotate(90deg)}
    .acc-body{display:none;padding:.5rem .9rem .8rem;border-top:1px solid rgba(255,255,255,.08)}
    .acc-item[aria-expanded="true"] .acc-body{display:block}
  </style>
</head>
<body>
  <header>
    <div class="title"><span class="dot"></span> Framing Lessons — Global Humanity Resource</div>
    <div class="controls">
      <label class="pill" for="mode">Mode</label>
      <select id="mode" aria-label="Select mode">
        <option value="Current" selected>Current</option>
        <option value="Historic">Historic</option>
        <option value="Hybrid">Hybrid</option>
      </select>
      <div class="hint">Hover a country to preview; click to lock. capstone: <a class="email" href="mailto:josryan@student.unimelb.edu.au">josryan@student.unimelb.edu.au</a></div>
    </div>
  </header>

  <main class="wrap">
    <section class="map-card">
      <div class="map-toolbar">
        <button id="resetZoom" title="Reset pan & zoom">Reset</button>
        <button id="unlockBtn" title="Unlock selection" disabled>Unlock</button>
      </div>
      <svg id="map"></svg>
      <div class="legend">
        <div class="swatch swatch-yes" aria-hidden="true"></div> has data ·
        <div class="swatch swatch-no" aria-hidden="true"></div> no data
      </div>
    </section>

    <aside class="panel" aria-live="polite">
      <h2 id="panelTitle">Global summary</h2>
      <div class="sub" id="panelSub">Showing all approaches in <span id="panelModeLabel">Current</span> mode.</div>
      <div class="locked" id="lockedRow" hidden><span class="led" style="width:8px;height:8px;border-radius:50%;background:#e7b84b;box-shadow:0 0 10px rgba(231,184,75,.6);"></span><span id="lockedText">Locked</span></div>
      <div class="cards" id="cards"></div>
      <div class="diag" id="diag"></div>
    </aside>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/topojson-client@3/dist/topojson-client.min.js"></script>
  <script>
  // =============================
  // CONFIG
  // =============================
  const dataCsvUrl = 'Countries_structure_framing_cleaned.csv';
  const pisaCsvUrl = null;

  // UI labels for virtual / region tokens
  const TOKEN_LABELS = {
    GLB: 'Globalised framing',
    MENA: 'MENA (region)',
    EUR: 'Europe (region)',
    WOI: 'AUS – VIC – Centre (Woiwurrung)',
    WAD: 'AUS – VIC – West of Centre (Wadawurrung)',
    GUL: 'AUS – VIC – South-West (Gulidjan)',
    WOIWURRUNG: 'AUS – VIC – Centre (Woiwurrung)',
    WADAWARRUNG: 'AUS – VIC – West of Centre (Wadawurrung)',
    GULIDJAN: 'AUS – VIC – South-West (Gulidjan)'
  };

  // Tokens that render as chips only (no polygon shading)
  const VIRTUAL_ONLY_TOKENS = new Set(['GLB']);

  // Indigenous anchors — shade AUS while preserving labels
  const ANCHOR_TOKENS_TO_ISO3 = {
    WOI:'AUS', WAD:'AUS', GUL:'AUS',
    WOIWURRUNG:'AUS', WADAWARRUNG:'AUS', GULIDJAN:'AUS'
  };

  // Multi‑country regions (edit as you see fit)
  const REGION_TO_ISO3S = {
    MENA: [ 'DZA','EGY','LBY','MAR','TUN','ARE','BHR','IRN','IRQ','ISR','JOR','KWT','LBN','OMN','PSE','QAT','SAU','SYR','TUR','YEM' ],
    EUR: [ 'ALB','AND','AUT','BEL','BGR','BIH','BLR','CHE','CYP','CZE','DEU','DNK','ESP','EST','FIN','FRA','GBR','GEO','GRC','HRV','HUN','IRL','ISL','ITA','LIE','LTU','LUX','LVA','MCO','MDA','MKD','MLT','MNE','NLD','NOR','POL','PRT','ROU','RUS','SMR','SRB','SVK','SVN','SWE','TUR','UKR','VAT' ]
  };
  const EXPAND_REGIONS_FOR_SHADING = new Set(['MENA','EUR']);

  // Alias tokens used in your CSV → ISO‑3
  const NON_ISO_TO_ISO3 = { 'UK':'GBR','NZ':'NZL','SIN':'SGP','SAF':'ZAF','ZIM':'ZWE','KNY':'KEN','GER':'DEU','NEP':'NPL' };

  // Tokens we never try to polygon‑shade (they’ll still show as chips)
  const NON_POLYGON_TOKENS = new Set(['GLB','GLOBAL','MENA','EUR','EUROPE','WOIWURRUNG','WADAWARRUNG','GULIDJAN']);

  const CANONICAL_HEADERS = [
    'CountryCode','Mode','ApproachName','Definition','SourceTypeContext','Author','TheoreticalStance','StudentFriendlyStrategy','ApplicationToHumanities','KeyQuotes','ConnectionsCritiques','GovernmentMandated','Orientation','Level'
  ];

  // =============================
  // STATE
  // =============================
  const state = {
    world:null,
    rows:[],
    rowsByMode:{Current:[],Historic:[],Hybrid:[]},
    rowsByModeIso3:{Current:new Map(),Historic:new Map(),Hybrid:new Map()},
    rowsByToken:{Current:new Map(),Historic:new Map(),Hybrid:new Map()},
    shadedIso3ByMode:{Current:new Set(),Historic:new Set(),Hybrid:new Set()},
    mode:'Current',
    lockedIso3:null,
    hoveredIso3:null,
    detectedHeaders:new Set(),
    pisaByIso3:null
    openKey: null,

  };

  // =============================
  // HELPERS
  // =============================
  const canon = s => (s||'').toString().trim();
  const canonHeader = s => canon(s).toLowerCase().replace(/[^a-z]/g,'');
  const stripParens = s => canon(s).replace(/\([^)]*\)/g,'').trim();

  function normalizeModeCell(val){
    const raw = stripParens(val);
    if(!raw) return [];
    const parts = raw.split(/[,/;]|\band\b/i).map(s=>s.trim()).filter(Boolean);
    const out = new Set();
    for(const p of parts){
      const l = p.toLowerCase();
      if(l==='current' || l==='contemporary' || l==='present') out.add('Current');
      else if(l==='historic' || l==='historical' || l==='past') out.add('Historic');
      else if(l==='hybrid' || l==='mixed' || l==='both') out.add('Hybrid');
    }
    return [...out];
  }

  function tokenToIso3(tokenRaw){
    const token = stripParens(tokenRaw).toUpperCase();
    if(!token) return null;
    if(NON_POLYGON_TOKENS.has(token)) return null;
    const left = token.split(/[\s]*[-–—][\s]*/)[0].trim();
    if(NON_ISO_TO_ISO3[left]) return NON_ISO_TO_ISO3[left];
    if(/^[A-Z]{3}$/.test(left)) return left;
    if(/^[A-Z]{2}$/.test(left)){
      const TWO = {US:'USA',AU:'AUS',GB:'GBR',CN:'CHN',DE:'DEU',BR:'BRA',IN:'IND',RU:'RUS',CA:'CAN',FR:'FRA',JP:'JPN',IT:'ITA',ES:'ESP',SE:'SWE',NO:'NOR',NL:'NLD',NZ:'NZL'};
      if(TWO[left]) return TWO[left];
    }
    return null;
  }

  function parseCountryTokens(cell){
    const raw = canon(cell);
    if(!raw) return { originalTokens:[], iso3s:[], displayTokens:[] };

    const tokens = raw.split(/[,，;|]/).map(s=>s.trim()).filter(Boolean);
    const iso3s = new Set();
    const displayTokens = [];

    for(const tRaw of tokens){
      const T = stripParens(tRaw).toUpperCase();

      if(REGION_TO_ISO3S[T] && EXPAND_REGIONS_FOR_SHADING.has(T)){
        REGION_TO_ISO3S[T].forEach(iso=>iso3s.add(iso));
        displayTokens.push(TOKEN_LABELS[T]||tRaw);
        continue;
      }
      if(ANCHOR_TOKENS_TO_ISO3[T]){
        iso3s.add(ANCHOR_TOKENS_TO_ISO3[T]);
        displayTokens.push(TOKEN_LABELS[T]||tRaw);
        continue;
      }
      if(VIRTUAL_ONLY_TOKENS.has(T)){
        displayTokens.push(TOKEN_LABELS[T]||tRaw);
        continue;
      }
      const iso = tokenToIso3(T);
      if(iso) iso3s.add(iso);
      displayTokens.push(TOKEN_LABELS[T]||tRaw);
    }

    return { originalTokens:tokens, iso3s:[...iso3s], displayTokens };
  }

  function normalizeRow(rawRow){
    const map={};
    for(const [k,v] of Object.entries(rawRow)){
      const keyCanon = canonHeader(k);
      state.detectedHeaders.add(k);
      for(const expected of CANONICAL_HEADERS){
        if(keyCanon===canonHeader(expected)){ map[expected]=v; break; }
      }
    }
    for(const h of CANONICAL_HEADERS){ if(!(h in map)) map[h]=''; }

    const country = parseCountryTokens(map['CountryCode']);
    const modes = normalizeModeCell(map['Mode']);
    return { ...map, __originalTokens:country.originalTokens, __displayTokens:country.displayTokens, __iso3s:country.iso3s, __modes:modes };
  }

  function groupByApproach(rows){
    const m = new Map();
    for(const r of rows){
      const key = canon(r.ApproachName) || '(Unnamed)';
      if(!m.has(key)) m.set(key,new Set());
      for(const tok of r.__originalTokens) m.get(key).add(tok);
    }
    return [...m.entries()].sort((a,b)=>a[0].localeCompare(b[0],undefined,{sensitivity:'base'})).map(([name,set])=>({name,locations:[...set]}));
  }

  // =============================
  // RENDER — Panel
  // =============================
  const cardsEl = document.getElementById('cards');
  const panelTitleEl = document.getElementById('panelTitle');
  const panelSubEl = document.getElementById('panelSub');
  const panelModeLabelEl = document.getElementById('panelModeLabel');
  const diagEl = document.getElementById('diag');
  const lockedRowEl = document.getElementById('lockedRow');
  const lockedTextEl = document.getElementById('lockedText');
  const unlockBtnEl = document.getElementById('unlockBtn');

  const el = (tag,attrs={},children=[])=>{ const e=document.createElement(tag); for(const [k,v] of Object.entries(attrs)){ if(k==='class') e.className=v; else if(k==='text') e.textContent=v; else e.setAttribute(k,v);} children.forEach(c=>e.appendChild(c)); return e; };
  const pill = text => el('span',{class:'chip',text});

  function renderDiagnostics(){
    const n = state.rows.length;
    const headers = [...state.detectedHeaders];
    const shaded = state.shadedIso3ByMode[state.mode].size;
    const worldCount = state.world?.features?.length || 0;
    diagEl.textContent = `Loaded ${n} rows. Headers seen: ${headers.join(' | ')}. Countries loaded: ${worldCount}. Shaded in ${state.mode}: ${shaded}.`;
  }

    function renderAccordion(rows){
  const list = el('div',{class:'accordion'});

  rows.forEach((r,idx)=>{
    const key = `${canon(r.ApproachName)||'(Unnamed)'}__${idx}`;

    const item = el('div',{class:'acc-item'});
    item.setAttribute('aria-expanded', String(state.openKey===key));

    // Header (click to toggle)
    const header = el('div',{class:'acc-header'});
    const left = el('div');
    left.appendChild(el('div',{class:'acc-title', text: r.ApproachName || '(Unnamed)'}));
    const chips = el('div',{class:'acc-chips'});
    if (canon(r.Orientation)) chips.appendChild(pill(canon(r.Orientation)));
    if (canon(r.Mode))        chips.appendChild(pill(canon(r.Mode)));
    left.appendChild(chips);
    const arrow = el('span',{class:'acc-arrow',text:'▶'});
    header.appendChild(left); header.appendChild(arrow);

    header.addEventListener('click',()=>{
      if (state.openKey===key){ state.openKey=null; item.setAttribute('aria-expanded','false'); return; }
      state.openKey = key;
      list.querySelectorAll('.acc-item').forEach(n=>n.setAttribute('aria-expanded','false'));
      item.setAttribute('aria-expanded','true');
      item.scrollIntoView({behavior:'smooth',block:'nearest'});
    });

    // Body (your existing sections)
    const body = el('div',{class:'acc-body'});
    const sections = [
      ['Definition','Definition'],
      ['Source / Context','SourceTypeContext'],
      ['Author','Author'],
      ['Theoretical stance','TheoreticalStance'],
      ['Student-friendly strategy','StudentFriendlyStrategy'],
      ['Application to humanities','ApplicationToHumanities'],
      ['Key quotes','KeyQuotes'],
      ['Connections / critiques','ConnectionsCritiques'],
      ['Government mandated','GovernmentMandated'],
      ['Level','Level']
    ];
    for (const [label,keyName] of sections){
      const val = canon(r[keyName]);
      if (!val) continue;
      const sec = el('div',{class:'section'});
      sec.appendChild(el('h4',{text:label}));
      sec.appendChild(el('p',{text:val}));
      body.appendChild(sec);
    }

    item.appendChild(header);
    item.appendChild(body);
    list.appendChild(item);
  });

  cardsEl.appendChild(list);
}

  function renderTokenDetail(T){
    const rows = state.rowsByToken[state.mode].get(T)||[];
    const label = TOKEN_LABELS[T] || T;
    panelTitleEl.textContent = label;
    panelSubEl.textContent = `Approaches in ${state.mode} (${REGION_TO_ISO3S[T] ? 'region' : 'virtual place'})`;
    lockedRowEl.hidden = true; unlockBtnEl.disabled = true;

    cardsEl.innerHTML='';
    if(!rows.length){ cardsEl.appendChild(el('div',{class:'empty',text:'No rows for this token in this mode.'})); renderDiagnostics(); return; }

    rows.sort((a,b)=> (canon(a.ApproachName).localeCompare(canon(b.ApproachName),undefined,{sensitivity:'base'})) || (canon(a.Level).localeCompare(canon(b.Level))));
    for(const r of rows){
      const card=el('div',{class:'card'});
      const h3=el('h3'); h3.appendChild(el('span',{text:r.ApproachName||'(Unnamed)'}));
      const chips=el('span',{class:'chips'});
      if(canon(r.Orientation)) chips.appendChild(pill(canon(r.Orientation)));
      if(canon(r.Mode)) chips.appendChild(pill(canon(r.Mode)));
      h3.appendChild(chips); card.appendChild(h3);

      const sections=[['Definition','Definition'],['Source / Context','SourceTypeContext'],['Author','Author'],['Theoretical stance','TheoreticalStance'],['Student‑friendly strategy','StudentFriendlyStrategy'],['Application to humanities','ApplicationToHumanities'],['Key quotes','KeyQuotes'],['Connections / critiques','ConnectionsCritiques'],['Government mandated','GovernmentMandated'],['Level','Level']];
      for(const [label,key] of sections){ const val=canon(r[key]); if(!val) continue; const sec=el('div',{class:'section'}); sec.appendChild(el('h4',{text:label})); sec.appendChild(el('p',{text:val})); card.appendChild(sec); }
      cardsEl.appendChild(card);
    }
    renderDiagnostics();
  }

  function renderGlobalSummary(){
    panelTitleEl.textContent='Global summary';
    panelModeLabelEl.textContent=state.mode;
    panelSubEl.innerHTML=`Showing all approaches in <span id="panelModeLabel">${state.mode}</span> mode.`;
    lockedRowEl.hidden=true; unlockBtnEl.disabled=true;

    const items = groupByApproach(state.rowsByMode[state.mode]);
    cardsEl.innerHTML='';
    if(!items.length){ cardsEl.appendChild(el('div',{class:'empty',text:'No data found for this mode.'})); }
    else {
      const wrap=el('div',{class:'summary-list'});
      for(const it of items){
        const card=el('div',{class:'summary-item'});
        card.appendChild(el('div',{class:'name',text:it.name}));
        card.appendChild(el('div',{class:'locs',text:it.locations.join(', ')}));
        wrap.appendChild(card);
      }
      cardsEl.appendChild(wrap);
    }

    // Regions & Peoples chips
    const tokenMap = state.rowsByToken[state.mode];
    if(tokenMap.size){
      const h=el('div',{class:'sub',text:'Regions & Peoples:'});
      const box=el('div'); box.style.display='flex'; box.style.flexWrap='wrap'; box.style.gap='8px';
      for(const T of [...tokenMap.keys()].sort()){
        const b=el('button',{class:'pill'}); b.textContent = TOKEN_LABELS[T] || T; b.onclick=()=>renderTokenDetail(T); box.appendChild(b);
      }
      cardsEl.appendChild(h); cardsEl.appendChild(box);
    }

    renderDiagnostics();
  }

  function renderCountryDetail(iso3){
    const name = (state.world?.features?.find(f=>f.properties.iso3===iso3)?.properties?.name) || iso3 || 'Unknown';
    panelTitleEl.textContent=name; panelModeLabelEl.textContent=state.mode; panelSubEl.textContent=`Approaches in ${state.mode} mode`;
    if(state.lockedIso3){ lockedTextEl.textContent=`Locked on ${name}`; lockedRowEl.hidden=false; unlockBtnEl.disabled=false; } else { lockedRowEl.hidden=true; unlockBtnEl.disabled=true; }

    const rows = (state.rowsByModeIso3[state.mode].get(iso3)||[]).slice();
    cardsEl.innerHTML=''; if(!rows.length){ cardsEl.appendChild(el('div',{class:'empty',text:'No rows for this country in this mode.'})); renderDiagnostics(); return; }

    rows.sort((a,b)=> (canon(a.ApproachName).localeCompare(canon(b.ApproachName),undefined,{sensitivity:'base'})) || (canon(a.Level).localeCompare(canon(b.Level))));
    for(const r of rows){
      state.openKey = rows.length ? `${canon(rows[0].ApproachName)||'(Unnamed)'}__0` : null;
      renderAccordion(rows);
    }
    renderDiagnostics();
  }

  // =============================
  // MAP — D3 setup
  // =============================
  const svg = d3.select('#map');
  const g = svg.append('g');
  const projection = d3.geoNaturalEarth1();
  const path = d3.geoPath(projection);
  const graticule = d3.geoGraticule10();
  g.append('path').attr('class','graticule').attr('d', path(graticule));
  const countriesG = g.append('g').attr('class','countries');
  const zoom = d3.zoom().scaleExtent([1,8]).on('zoom', (ev)=>{ g.attr('transform',ev.transform); });
  svg.call(zoom);
  document.getElementById('resetZoom').addEventListener('click',()=>{ svg.transition().duration(400).call(zoom.transform,d3.zoomIdentity); });
  document.getElementById('unlockBtn').addEventListener('click',()=>{ state.lockedIso3=null; updateLockStyles(); maybeRenderPanel(); });

  function updateLockStyles(){ countriesG.selectAll('path.country').classed('locked', d => d.properties.iso3===state.lockedIso3); }
  function shadeByMode(){ const set=state.shadedIso3ByMode[state.mode]; countriesG.selectAll('path.country').classed('hasData', d => set.has(d.properties.iso3)); }
  function maybeRenderPanel(){ if(state.lockedIso3) renderCountryDetail(state.lockedIso3); else if(state.hoveredIso3) renderCountryDetail(state.hoveredIso3); else renderGlobalSummary(); }

  // =============================
  // DATA — load world + CSV
  // =============================
  async function loadWorld(){
    // Use Visionscarto atlas with ISO‑3 in properties.a3
    const topoUrl = 'https://cdn.jsdelivr.net/npm/visionscarto-world-atlas@1.0.0/world/110m.json';
    const topo = await fetch(topoUrl).then(r=>r.json());
    const countries = topojson.feature(topo, topo.objects.countries);
    countries.features.forEach(f=>{ f.properties.iso3 = (f.properties.a3||'').toUpperCase()||null; f.properties.name = f.properties.name || f.properties.name_en || 'Unknown'; });
    state.world = countries;
  }

  async function loadDataCsv(){
    const raw = await d3.csv(dataCsvUrl);
    const normalized = raw.map(normalizeRow).filter(r => r && (r.__modes.length>0 || r.__iso3s.length>0 || canon(r.ApproachName) || canon(r.CountryCode)));
    state.rows = normalized;
    for(const r of normalized){
      for(const m of r.__modes){
        state.rowsByMode[m].push(r);
        for(const iso of r.__iso3s){
          if(!state.rowsByModeIso3[m].has(iso)) state.rowsByModeIso3[m].set(iso,[]);
          state.rowsByModeIso3[m].get(iso).push(r);
          state.shadedIso3ByMode[m].add(iso);
        }
        const tokenMap = state.rowsByToken[m];
        for(const tok of r.__displayTokens){
          const T = stripParens(tok).toUpperCase();
          const isRegion = !!REGION_TO_ISO3S[T];
          const isAnchor = !!ANCHOR_TOKENS_TO_ISO3[T];
          const isVirtualOnly = VIRTUAL_ONLY_TOKENS.has(T);
          if(isRegion || isAnchor || isVirtualOnly){ if(!tokenMap.has(T)) tokenMap.set(T,[]); tokenMap.get(T).push(r); }
        }
      }
    }
  }

  function drawMap(){
    countriesG.selectAll('path.country')
      .data(state.world.features.filter(f=>!!f.properties.iso3))
      .join('path')
      .attr('class','country')
      .attr('d',path)
      .on('mouseover',(ev,d)=>{ if(state.lockedIso3) return; state.hoveredIso3=d.properties.iso3||null; maybeRenderPanel(); })
      .on('mouseout',()=>{ if(state.lockedIso3) return; state.hoveredIso3=null; maybeRenderPanel(); })
      .on('click',(ev,d)=>{ const iso=d.properties.iso3||null; if(!iso) return; state.lockedIso3=(state.lockedIso3===iso)?null:iso; updateLockStyles(); maybeRenderPanel(); });
    shadeByMode();
  }

  async function boot(){
    try{ await Promise.all([loadWorld(), loadDataCsv()]); drawMap(); renderGlobalSummary(); }
    catch(err){ console.error(err); cardsEl.innerHTML='<div class="empty">Failed to load data. Check CSV path (dataCsvUrl) and network permissions.</div>'; }
  }

  document.getElementById('mode').addEventListener('change',(e)=>{ state.mode=e.target.value; document.getElementById('panelModeLabel').textContent=state.mode; shadeByMode(); maybeRenderPanel(); });

  boot();
  </script>
</body>
</html>
